"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[858],{3905:(e,t,n)=>{n.d(t,{Zo:()=>c,kt:()=>h});var i=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,i,a=function(e,t){if(null==e)return{};var n,i,a={},r=Object.keys(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var d=i.createContext({}),s=function(e){var t=i.useContext(d),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=s(e.components);return i.createElement(d.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},p=i.forwardRef((function(e,t){var n=e.components,a=e.mdxType,r=e.originalType,d=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),p=s(n),h=a,m=p["".concat(d,".").concat(h)]||p[h]||u[h]||r;return n?i.createElement(m,o(o({ref:t},c),{},{components:n})):i.createElement(m,o({ref:t},c))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var r=n.length,o=new Array(r);o[0]=p;var l={};for(var d in t)hasOwnProperty.call(t,d)&&(l[d]=t[d]);l.originalType=e,l.mdxType="string"==typeof e?e:a,o[1]=l;for(var s=2;s<r;s++)o[s]=n[s];return i.createElement.apply(null,o)}return i.createElement.apply(null,n)}p.displayName="MDXCreateElement"},8407:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>l,toc:()=>s});var i=n(7462),a=(n(7294),n(3905));const r={},o="Discord",l={unversionedId:"authenticate/oauth/backend-oauth2-0013-discord",id:"authenticate/oauth/backend-oauth2-0013-discord",title:"Discord",description:"Discord OAuth2 integration allows you to use discord as an identity provider.",source:"@site/docs/authenticate/oauth/81-backend-oauth2-0013-discord.md",sourceDirName:"authenticate/oauth",slug:"/authenticate/oauth/backend-oauth2-0013-discord",permalink:"/docs/authenticate/oauth/backend-oauth2-0013-discord",draft:!1,editUrl:"https://github.com/authp/authp.github.io/edit/main/docs/authenticate/oauth/81-backend-oauth2-0013-discord.md",tags:[],version:"current",sidebarPosition:81,frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"AWS Cognito",permalink:"/docs/authenticate/oauth/backend-oauth2-0012-cognito"},next:{title:"Advanced Features",permalink:"/docs/authenticate/oauth/backend-oauth2-endpoint"}},d={},s=[{value:"Registering a discord application",id:"registering-a-discord-application",level:3},{value:"Sample Caddyfile configuration",id:"sample-caddyfile-configuration",level:3},{value:"Filtering by guild",id:"filtering-by-guild",level:3}],c={toc:s};function u(e){let{components:t,...r}=e;return(0,a.kt)("wrapper",(0,i.Z)({},c,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"discord"},"Discord"),(0,a.kt)("p",null,"Discord OAuth2 integration allows you to use discord as an identity provider."),(0,a.kt)("p",null,'It also allows you to add roles to the users based on which "discord servers" they are members of.'),(0,a.kt)("h3",{id:"registering-a-discord-application"},"Registering a discord application"),(0,a.kt)("p",null,"In order to use this plugin with caddy-security you'll need a to register an application in the ",(0,a.kt)("a",{parentName:"p",href:"https://discord.com/developers/applications"},"Discord Developer Portal"),"."),(0,a.kt)("p",null,"Once an application has been created go to the OAuth tab:"),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"Discord Application Dashboard",src:n(5113).Z,width:"1266",height:"715"})),(0,a.kt)("p",null,"Copy the ",(0,a.kt)("inlineCode",{parentName:"p"},"CLIENT ID")," and ",(0,a.kt)("inlineCode",{parentName:"p"},"CLIENT SECRET")," and click on ",(0,a.kt)("inlineCode",{parentName:"p"},"Add Redirect")," to add the caddy-security redirect"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"For an app hosted on ",(0,a.kt)("inlineCode",{parentName:"li"},"localhost:443")," with the auth portal on route ",(0,a.kt)("inlineCode",{parentName:"li"},"/auth")," add the following redirect: ",(0,a.kt)("inlineCode",{parentName:"li"},"https://localhost/auth/oauth2/discord/authorization-code-callback"))),(0,a.kt)("p",null,"Be sure to save the changes before closing the browser."),(0,a.kt)("h3",{id:"sample-caddyfile-configuration"},"Sample Caddyfile configuration"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-caddyfile"},"oauth identity provider discord {\n  realm discord\n  driver discord\n  client_id {$CLIENT_ID}\n  client_secret {$CLIENT_SECRET}\n  scopes identify email guilds # Optional, see notes below\n  user_group_filters {$DISCORD_GUILD_ID} {$OTHER_GUILD_ID} # Optional, effective only if scope guilds is specified\n}\n")),(0,a.kt)("p",null,'By default the request for authentication to discord is made only with the "identify" scope (the bare minimum) and that will give you back the id, username and avatar of the logged in user.'),(0,a.kt)("p",null,"you can then match the user ID in the a ",(0,a.kt)("inlineCode",{parentName:"p"},"transform user")," directive like this:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-caddyfile"},"transform user {\n    match sub discord.com/{$DISCORD_USER_ID}\n    action add role authp/admin\n}\n")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Note"),": The DISCORD_USER_ID is a number uniquely identifying the user in question.\nTo get a discord ID for a particular user using the discord desktop app:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"Enable developer mode by going to Settings->","[","App Settings","]","->Advanced->Enable Developer Mode"),(0,a.kt)("li",{parentName:"ol"},'Right click on a user and the last option in the popup menu will be "Copy ID"')),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Note"),': If you add "email" to the list of scopes requested the email will also be saved.'),(0,a.kt)("h3",{id:"filtering-by-guild"},"Filtering by guild"),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Note"),': "Guild" is the discord terminology for a "discord server"'),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Note"),": In order to disciminate users based on which guild they belong to you have to enable the guild scope in the discord oauth configuratio above (",(0,a.kt)("inlineCode",{parentName:"p"},"scopes identity guild"),")"),(0,a.kt)("p",null,"After the user is authenticated another query is made to the discord api requesting a list of guild IDs the user is part of. By default the result is ignored, which means no new roles will be added to the user object based on guild membership."),(0,a.kt)("p",null,"To create roles based on the user's membership of ALL his guilds use ",(0,a.kt)("inlineCode",{parentName:"p"},"user_group_filters *")," in the discord oauth configuration."),(0,a.kt)("p",null,"If you are only interested in the membership of a particular guild then add the guild id like this: ",(0,a.kt)("inlineCode",{parentName:"p"},"user_group_filters 1254335")),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"NOTE"),": To get a guild id follow the same instructions as for a DISCORD_USER_ID (explained above)"),(0,a.kt)("p",null,"If the ",(0,a.kt)("inlineCode",{parentName:"p"},"user_group_filters")," filter check passes then additional ",(0,a.kt)("inlineCode",{parentName:"p"},"roles")," will be added to the user as following:"),(0,a.kt)("ol",null,(0,a.kt)("li",{parentName:"ol"},"If the user is a member of a guild => role ",(0,a.kt)("inlineCode",{parentName:"li"},"discord.com/{$DISCORD_GUILD_ID}/members")),(0,a.kt)("li",{parentName:"ol"},"If the user has admin privileges in a guild => role ",(0,a.kt)("inlineCode",{parentName:"li"},"discord.com/{$DISCORD_GUILD_ID}/admins"))),(0,a.kt)("p",null,"You can them match them like this:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-caddyfile"},"transform user {\n    match role discord.com/{$DISCORD_GUILD_ID}/admins\n    action add role authp/admin\n}\n\ntransform user {\n    match role discord.com/{$DISCORD_GUILD_ID}/members\n    action add role authp/user\n}\n")))}u.isMDXComponent=!0},5113:(e,t,n)=>{n.d(t,{Z:()=>i});const i=n.p+"assets/images/oauth2_discord_new_app-df024e6fb4de2e3cf1da677c0c5d88cf.jpg"}}]);